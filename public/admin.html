<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel</title>
<style>
  body {
    background: #121212;
    color: #fff;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    max-width: 700px;
    margin: 40px auto;
    padding: 20px;
  }
  h1 { text-align: center; margin-bottom: 1rem; }
  form {
    background: #1e1e1e;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 2rem;
  }
  label {
    display: block;
    margin: 10px 0 5px;
  }
  input[type="text"],
  input[type="password"],
  select,
  textarea {
    width: 100%;
    padding: 8px;
    border-radius: 6px;
    border: none;
    background: #000;
    color: #ffcc00;
  }
  button {
    margin-top: 15px;
    padding: 10px 20px;
    background: #ffcc00;
    color: #000;
    border: none;
    border-radius: 6px;
    font-weight: 700;
    cursor: pointer;
  }
  button:hover {
    background: #e6b800;
  }
  #logoutBtn {
    background: #ff4444;
    color: #fff;
    float: right;
  }
  #logoutBtn:hover {
    background: #cc3333;
  }
  .character-list {
    margin-top: 2rem;
  }
  .character-item {
    background: #222;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 12px;
  }
  .character-item > button {
    margin-left: 10px;
    background: #444;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    padding: 5px 10px;
  }
  .character-item > button:hover {
    background: #666;
  }
  .character-item > button.edit-btn {
    background: #2ecc40; /* green for edit */
  }
  .character-item > button.edit-btn:hover {
    background: #27ae38;
  }
  .character-item > button.delete-btn {
    background: #ff4444; /* red for delete */
  }
  .character-item > button.delete-btn:hover {
    background: #cc3333;
  }
  textarea {
    resize: vertical;
    height: 60px;
  }
  .message {
    margin-bottom: 1rem;
    font-weight: 700;
  }
  /* Home button styling */
  #homeBtn {
    width: 100%;
    background-color: #333333;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 12px 0;
    font-weight: 700;
    margin-bottom: 20px;
    cursor: pointer;
  }
  #homeBtn:hover {
    background-color: #444444;
  }
</style>
</head>
<body>

<h1>Admin Panel</h1>
<button id="logoutBtn" style="display:none;">Logout</button>

<!-- Home button -->
<button id="homeBtn">Home</button>

<div id="loginSection">
  <form id="loginForm">
    <label for="username">Username</label>
    <input id="username" type="text" autocomplete="username" required />
    <label for="password">Password</label>
    <input id="password" type="password" autocomplete="current-password" required />
    <button type="submit">Login</button>
  </form>
</div>

<div id="adminSection" style="display:none;">
  <form id="characterForm">
    <h2>Add / Edit Character</h2>
    <input type="hidden" id="charId" />

    <label for="category">Category</label>
    <input id="category" type="text" placeholder="Category" />

    <label for="name">Name</label>
    <input id="name" type="text" required />

    <label for="affiliation">Affiliation</label>
    <input id="affiliation" type="text" />

    <label for="attribute">Attribute</label>
    <select id="attribute">
      <option value="">-- Select Attribute --</option>
      <option value="DEX">DEX</option>
      <option value="VIT">VIT</option>
      <option value="STR">STR</option>
      <option value="INT">INT</option>
    </select>

    <label for="type">Type</label>
    <select id="type">
      <option value="">-- Select Type --</option>
      <option value="DPS">DPS</option>
      <option value="Tank">Tank</option>
      <option value="Debuffer">Debuffer</option>
      <option value="Support">Support</option>
    </select>

    <label for="image_path">Image Filename</label>
    <input id="image_path" type="text" placeholder="e.g. image-123456.png" />

    <!-- Normal Skill -->
    <label for="normalSkillName">Normal Skill Name</label>
    <input id="normalSkillName" type="text" placeholder="Normal skill name" />
    <label for="normalSkillDesc">Normal Skill Description</label>
    <textarea id="normalSkillDesc" placeholder="Normal skill description"></textarea>

    <!-- Special Skill -->
    <label for="specialSkillName">Special Skill Name</label>
    <input id="specialSkillName" type="text" placeholder="Special skill name" />
    <label for="specialSkillDesc">Special Skill Description</label>
    <textarea id="specialSkillDesc" placeholder="Special skill description"></textarea>

    <!-- Ultimate Move -->
    <label for="ultimateMoveName">Ultimate Move Name</label>
    <input id="ultimateMoveName" type="text" placeholder="Ultimate move name" />
    <label for="ultimateMoveDesc">Ultimate Move Description</label>
    <textarea id="ultimateMoveDesc" placeholder="Ultimate move description"></textarea>

    <label for="mentorRecommendation">Mentor Recommendation(s)</label>
    <textarea id="mentorRecommendation" placeholder="Mentor recommendation text or JSON"></textarea>

    <button type="submit">Save Character</button>
  </form>

  <div class="character-list" id="characterList"></div>
</div>

<script>
  const loginSection = document.getElementById('loginSection');
  const adminSection = document.getElementById('adminSection');
  const logoutBtn = document.getElementById('logoutBtn');
  const characterList = document.getElementById('characterList');

  const charForm = document.getElementById('characterForm');
  const charIdInput = document.getElementById('charId');
  const categoryInput = document.getElementById('category');
  const nameInput = document.getElementById('name');
  const affiliationInput = document.getElementById('affiliation');
  const attributeSelect = document.getElementById('attribute');
  const typeSelect = document.getElementById('type');
  const imagePathInput = document.getElementById('image_path');

  const normalSkillNameInput = document.getElementById('normalSkillName');
  const normalSkillDescInput = document.getElementById('normalSkillDesc');

  const specialSkillNameInput = document.getElementById('specialSkillName');
  const specialSkillDescInput = document.getElementById('specialSkillDesc');

  const ultimateMoveNameInput = document.getElementById('ultimateMoveName');
  const ultimateMoveDescInput = document.getElementById('ultimateMoveDesc');

  const mentorRecommendationInput = document.getElementById('mentorRecommendation');

  let characters = [];

  // Home button click handler
  document.getElementById('homeBtn').addEventListener('click', () => {
    window.location.href = '/';
  });

  // Utility: Load all characters
  async function loadCharacters() {
    try {
      const res = await fetch('/api/characters', { credentials: 'include' });
      if (!res.ok) throw new Error('Failed to load characters');
      characters = await res.json();
      renderCharacterList();
    } catch (err) {
      alert(err.message);
    }
  }

  // Render character list with edit/delete buttons
  function renderCharacterList() {
    characterList.innerHTML = '';
    characters.forEach(c => {
      const div = document.createElement('div');
      div.className = 'character-item';

      const mentorSnippet = c.Mentor_Recommendations
        ? (typeof c.Mentor_Recommendations === 'string'
           ? c.Mentor_Recommendations.substring(0, 60) + (c.Mentor_Recommendations.length > 60 ? '...' : '')
           : JSON.stringify(c.Mentor_Recommendations).substring(0, 60) + '...')
        : '';

      div.innerHTML = `
        <strong>${escapeHtml(c.name)}</strong> â€” <em>${escapeHtml(c.Category || 'No Category')}</em><br/>
        Affiliation: ${escapeHtml(c.Affiliation || '-')}<br/>
        Attribute / Type: ${escapeHtml(c.Attribute || '-')}/${escapeHtml(c.Type || '-')}<br/>
        Image: ${escapeHtml(c.image_path || 'N/A')}<br/><br/>

        <strong>Normal Skill:</strong> ${escapeHtml(getSkillDisplay(c.Normal_Skill))}<br/>
        <strong>Special Skill:</strong> ${escapeHtml(getSkillDisplay(c.Special_Skill))}<br/>
        <strong>Ultimate Move:</strong> ${escapeHtml(getSkillDisplay(c.Ultimate_Move))}<br/><br/>

        <em>Mentor Recommendation(s):</em> ${escapeHtml(mentorSnippet)}

        <br/><br/>
        <button class="edit-btn" onclick="editCharacter(${c.id})">Edit</button>
        <button class="delete-btn" onclick="deleteCharacter(${c.id})">Delete</button>
      `;
      characterList.appendChild(div);
    });
  }

  // Helper to show skill as "Name: Description" if object, else string
  function getSkillDisplay(skill) {
    if (!skill) return '-';
    if (typeof skill === 'string') return skill;
    if (typeof skill === 'object') {
      // Expecting {name: "...", description: "..."} or similar
      if ('name' in skill && 'description' in skill) {
        return `${skill.name}: ${skill.description}`;
      }
      return JSON.stringify(skill);
    }
    return '-';
  }

  // Escape HTML for safety
  function escapeHtml(text) {
    if (!text) return '';
    return text.toString()
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // Edit character: populate form
  window.editCharacter = function(id) {
    const char = characters.find(c => c.id === id);
    if (!char) return;
    charIdInput.value = char.id || '';
    categoryInput.value = char.Category || '';
    nameInput.value = char.name || '';
    affiliationInput.value = char.Affiliation || '';
    attributeSelect.value = char.Attribute || '';
    typeSelect.value = char.Type || '';
    imagePathInput.value = char.image_path || '';

    // Handle skills as objects or strings
    if (char.Normal_Skill && typeof char.Normal_Skill === 'object') {
      normalSkillNameInput.value = char.Normal_Skill.name || '';
      normalSkillDescInput.value = char.Normal_Skill.description || '';
    } else {
      normalSkillNameInput.value = '';
      normalSkillDescInput.value = char.Normal_Skill || '';
    }

    if (char.Special_Skill && typeof char.Special_Skill === 'object') {
      specialSkillNameInput.value = char.Special_Skill.name || '';
      specialSkillDescInput.value = char.Special_Skill.description || '';
    } else {
      specialSkillNameInput.value = '';
      specialSkillDescInput.value = char.Special_Skill || '';
    }

    if (char.Ultimate_Move && typeof char.Ultimate_Move === 'object') {
      ultimateMoveNameInput.value = char.Ultimate_Move.name || '';
      ultimateMoveDescInput.value = char.Ultimate_Move.description || '';
    } else {
      ultimateMoveNameInput.value = '';
      ultimateMoveDescInput.value = char.Ultimate_Move || '';
    }

    mentorRecommendationInput.value = char.Mentor_Recommendations
      ? (typeof char.Mentor_Recommendations === 'string'
         ? char.Mentor_Recommendations
         : JSON.stringify(char.Mentor_Recommendations, null, 2))
      : '';
  };

  // Delete character
  window.deleteCharacter = async function(id) {
    if (!confirm('Are you sure you want to delete this character?')) return;
    try {
      const res = await fetch(`/api/characters/${id}`, { method: 'DELETE', credentials: 'include' });
      if (!res.ok) throw new Error('Failed to delete character');
      alert('Deleted!');
      await loadCharacters();
      charForm.reset();
    } catch (err) {
      alert(err.message);
    }
  };

  // Login form submission
  document.getElementById('loginForm').addEventListener('submit', async e => {
    e.preventDefault();
    const username = e.target.username.value;
    const password = e.target.password.value;
    try {
      const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password }),
        credentials: 'include'
      });
      if (!res.ok) throw new Error('Invalid username or password');
      loginSection.style.display = 'none';
      adminSection.style.display = 'block';
      logoutBtn.style.display = 'inline-block';
      await loadCharacters();
    } catch (err) {
      alert(err.message);
    }
  });

  // Logout button
  logoutBtn.addEventListener('click', async () => {
    try {
      const res = await fetch('/api/logout', {
        method: 'POST',
        credentials: 'include'
      });
      if (!res.ok) throw new Error('Logout failed');
      loginSection.style.display = 'block';
      adminSection.style.display = 'none';
      logoutBtn.style.display = 'none';
      charForm.reset();
    } catch (err) {
      alert(err.message);
    }
  });

  // Character form submit (Add/Edit)
  charForm.addEventListener('submit', async e => {
    e.preventDefault();
    const id = charIdInput.value;

    // Build skill objects or fallback strings
    const normalSkill = (normalSkillNameInput.value.trim() || normalSkillDescInput.value.trim())
      ? { name: normalSkillNameInput.value.trim(), description: normalSkillDescInput.value.trim() }
      : '';

    const specialSkill = (specialSkillNameInput.value.trim() || specialSkillDescInput.value.trim())
      ? { name: specialSkillNameInput.value.trim(), description: specialSkillDescInput.value.trim() }
      : '';

    const ultimateMove = (ultimateMoveNameInput.value.trim() || ultimateMoveDescInput.value.trim())
      ? { name: ultimateMoveNameInput.value.trim(), description: ultimateMoveDescInput.value.trim() }
      : '';

    let mentorRecommendationVal = mentorRecommendationInput.value.trim();
    // Try parse JSON for mentor recommendation, fallback to string
    try {
      mentorRecommendationVal = mentorRecommendationVal ? JSON.parse(mentorRecommendationVal) : '';
    } catch {
      // keep as string
    }

    const data = {
      Category: categoryInput.value.trim(),
      name: nameInput.value.trim(),
      Affiliation: affiliationInput.value.trim(),
      Attribute: attributeSelect.value,
      Type: typeSelect.value,
      image_path: imagePathInput.value.trim(),
      Normal_Skill: normalSkill,
      Special_Skill: specialSkill,
      Ultimate_Move: ultimateMove,
      Mentor_Recommendations: mentorRecommendationVal,
    };

    try {
      let res;
      if (id) {
        // Update
        res = await fetch(`/api/characters/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data),
        });
      } else {
        // Create
        res = await fetch('/api/characters', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data),
        });
      }
      if (!res.ok) throw new Error('Failed to save character');
      alert('Character saved successfully!');
      await loadCharacters();
      charForm.reset();
    } catch (err) {
      alert(err.message);
    }
  });

  // On page load, check login status by trying to fetch characters
  (async () => {
    try {
      await loadCharacters();
      loginSection.style.display = 'none';
      adminSection.style.display = 'block';
      logoutBtn.style.display = 'inline-block';
    } catch {
      loginSection.style.display = 'block';
      adminSection.style.display = 'none';
      logoutBtn.style.display = 'none';
    }
  })();
</script>

</body>
</html>
